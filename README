fIRST YOU NEED TO DOWNLOAD THE FILES FROM THE GITHUB :
https://github.com/Yatodak/DevOpsCTF


GUACAMOLE SERVER :

INSTALL ALL DEPENDENCIES :
# sudo apt install -y dialog
# sudo apt install -y libcairo2-dev libjpeg62-dev libpng-dev libtool-bin uuid-dev libpango1.0-dev libssh2-1-dev libssl-dev
# sudo apt install -y libjpeg-turbo8-dev make unzip
# sudo apt install -y openjdk-19-jdk

EXTRACT AND COPY THE GUACAMOLE FOLDER IN /etc
# sudo unzip guacamole-config.zip -d /etc


NOW EXTRACT, BUILD AND INSTALL GUACAMOLE
# tar xzf guacamole-server-1.5.3.tar.gz
# cd guacamole-server-1.5.3
# ./configure --with-init-dir=/etc/init.d
# sudo make
# sudo make install
# sudo ldconfig
# sudo systemctl daemon-reload
# sudo systemctl enable --now guacd


######################################################################################################################################

GUACAMOLE GUI :

SETUP THE MARIADB DATABASE
# sudo apt install -y mariadb-server
# sudo systemctl enable --now mariadb

## Enter the next command in one copy/paste in a notepadd and change the root password
sudo mariadb -uroot <<_EOF_
UPDATE mysql.user SET Password=PASSWORD('ChangeMe') WHERE User='root';
UPDATE mysql.user SET Plugin='mysql_native_password' WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
CREATE DATABASE guacamole_db;
_EOF_

## Let's init the Guacamole DB
cat schema/*.sql | mysql -uroot -p guacamole_db
mysql -uroot -p <<_EOF_
CREATE USER 'guacamole_user'@'localhost' IDENTIFIED BY 'ChangeMe';
GRANT SELECT,INSERT,UPDATE,DELETE ON guacamole_db.* TO 'guacamole_user'@'localhost';
FLUSH PRIVILEGES;
_EOF_

## Modify the password in /etc/guacamole/guacamole.properties
Modify the mysql-password with the password you set for the guacamole_user

UNZIP THE TOMCAT IN /opt FOLDER
# unzip tomcat.zip && sudo mv tomcat /opt


FIRST SET THE UMASK :
# umask 022

YOU NEED TO CREATE A USER CALLED TOMCAT :
# sudo useradd -r -s /usr/sbin/nologin tomcat

ADD A LOG FOLDER FOR TOMCAT :
# sudo mkdir /var/log/tomcat
# sudo chown tomcat:adm /var/log/tomcat
# sudo chmod 750 /var/log/tomcat
# sudo chmod g+s /var/log/tomcat


REPLACE THE CATALINE LOGS FOLDER WITH THE NEW LOGS FOLDER :
# cd /opt/tomcat
# sudo rm -rf logs
# sudo ln -s /var/log/tomcat /opt/tomcat/logs

NOW CONFIGURE FILE PERMISSIONS :
# sudo su -
# sudo chown -R root:tomcat /opt/tomcat
# sudo chmod g+r /opt/tomcat/conf/*
# sudo chmod g+w /opt/tomcat/temp /opt/tomcat/work
# exit


NOW VERIFY THAT TOMCAT ONLY AS WRITE ACCESS TO TEMP, WORK AND LOGS AND REMOVE ALL OTHER USER PERMISSIONS TO TOMCAT FOLDER :
# sudo chmod -R o-rwx /opt/tomcat/


ADD THE tomcat.service FILE IN /etc/systemd/system/
## Return to cloned git folder
# sudo cp tomcat.service /etc/systemd/system/
# sudo systemctl daemon-reload
# sudo systemctl enable --now tomcat


TO RUN, TOMCAT NEED THE JAVA_HOME VARIABLE POINTING TO THE RIGHT JDK FOLDER
BY DEFAULT THE FOLDER IS SET IN THE SERVICE FILE AT /usr/lib/jvm/java-19-openjdk-amd64

NOW FOR CTFD
### Unzip and copy ctfd folder in /opt
# unzip ctfd.zip && sudo mv CTFd /opt

### Copy the ctfd service file
# sudo apt install -y gunicorn build-essential python-dev python3-pip libffi-dev
# sudo -H pip install -r /opt/CTFd/requirements.txt
# sudo mv ctfd.service /etc/systemd/system

### Setup Database for CTFd
mariadb -uroot -p <<_EOF_
CREATE DATABASE ctfd;
CREATE USER 'ctfduser'@'localhost' IDENTIFIED BY 'ChangeMe';
GRANT USAGE ON *.* TO 'ctfduser'@'localhost' IDENTIFIED BY 'ctfd';
GRANT ALL privileges ON ctfd.* TO 'ctfduser'@'localhost';FLUSH PRIVILEGES;
_EOF_


IF YOU HAVE A DIFFERENT FOLDER, YOU NEED TO MODIFY THE ENVIRONEMENT VARIABLE IN THE tomcat.service FILE


